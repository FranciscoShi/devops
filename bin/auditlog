#!/usr/bin/env python3
#-*- coding: utf-8 -*-
##############################################
# Home	: http://netkiller.github.io
# Author: Neo <netkiller@msn.com>
##############################################
import os,io,sys
import logging, configparser
import threading
from optparse import OptionParser, OptionGroup
import time
from datetime import datetime	
import re

class Auditlog():
	def __init__(self, workspace = None, logging = None):
		#usage = "usage: %prog [options] {branch|stage} project"
		usage = ''
		self.parser = OptionParser(usage)

		self.parser.add_option("-l", "--logfile", dest="logfile", default=None,help="log file")
		self.parser.add_option('-r','--regular', dest="regular", default=None, help='regular')
		self.parser.add_option('-d','--daemon', dest='daemon', action='store_true', default=False, help='run as daemon')
		self.parser.add_option('', "--debug", action="store_true", help="Print debug information")
		#self.parser.add_option('','--clean', action="store_true", help='')
		
		#group = OptionGroup(self.parser, "stage", "development | testing | production")
		#self.parser.add_option_group(group)
		#group = OptionGroup(self.parser, 'project', '<host>.<domain>')
		#self.parser.add_option_group(group)

		#group = OptionGroup(self.parser, "branch", "branch management")
		#group.add_option("-c", "--checkout", dest="checkout", metavar="master|trunk", default='', help="checkout branch")		
		#group.add_option('-n', "--new", dest="new", metavar="branch", default=None, help="Create new branch")
		#group.add_option("-d", "--delete", dest="delete", metavar="branch", help="delete branch")
		#group.add_option('','--release', dest="release", help='release version exampe:'+ time.strftime('%Y-%m-%d',time.localtime(time.time())) , default=None)
		#group.add_option("-e", action="store_true", help="Print every action done")
		
		#self.parser.add_option_group(group)
		
		#self.parser.add_option('-v','--version',action='store_true', help='print version number')
		#self.parser.add_option('','--logfile', help='logs file.', default='backup.log')	

		(self.options, self.args) = self.parser.parse_args()
		
		basedir=os.path.dirname(os.path.dirname(os.path.abspath(__file__)))	
		#conf = basedir+'/etc/'+'auditlog.ini'
		#print(conf)
		self.configure(basedir+'/etc/'+'auditlog.ini')

	def usage(self):
		self.parser.print_help()
		#print("\n  Example: \n\tdeployment testing www.example.com\n\tdeployment production www.example.com --clean\n\tdeployment testing bbs.example.com --backup=/tmp/backup")
		print("\n  Homepage: http://netkiller.github.com\n  Author: Neo <netkiller@msn.com>")
		
	def filter(self, logfile, regular):
		with open(logfile) as files:
			regex=regular
			for line in files:
				if re.search(regex, line):
					print(line.strip())

	def configure(self,inifile, section = None):
		conf = {}
		try:
			if not os.path.exists(inifile):
				raise Exception('Cannot open file', inifile)
			config = configparser.SafeConfigParser()
			config.read(inifile)

			if section :
				conf = dict(config.items(section))
			else:
				for sect in config.sections():
					conf[sect] = dict(config.items(sect))

		except configparser.NoSectionError as err:
			print("Error: %s %s" %(err, inifile))
			sys.exit(1)
		except Exception as err:
			print("Error: %s %s" %(err, inifile))
			sys.exit(1)
		
		self.config = conf
	def daemon(self):
		try:
			#print(self.config)
			for section in self.config:
				item = self.config[section]
				#print(item)
				logfile = item['logfile']
				regular = item['regular']

				if not os.path.exists(logfile):
					raise Exception('Cannot open file', logfile)

				if not os.path.exists(regular):
					raise Exception('Cannot open file', regular)

				regexs = []
				with open(regular,'r') as regulardata:
					for line in regulardata:
						regexs.append(line.strip())
				#print(regexs)
				
				with open(logfile,'r') as logdata:
					#print(regulardata.readlines())
					for line in logdata:
						#print(line)
						for regex in regexs:
							#print(regex.strip(), line.strip())
							if re.search(regex.strip(), line.strip()):
								print(line.strip())
							#else:
							#	print(line)
				regulardata.close()
		except Exception as err:
			print("Error: %s %s" %(err, 'daemon'))
			sys.exit(1)
			
	def main(self):

		if self.options.daemon:
			pid = os.fork()
			if pid > 0:
				#self.logging.info('daemon is ok')
				self.daemon()
				sys.exit(0)
		else:
			if self.options.logfile and self.options.regular:
				self.filter(self.options.logfile, self.options.regular)
			else:
				self.usage()
		
		if self.options.debug:
			print("===================================")
			print(self.options, self.args)
			print("===================================")

if __name__ == '__main__':
	try:
		auditlog = Auditlog()
		#deployment.debug = True
		#auditlog.usage()
		auditlog.main()
	except KeyboardInterrupt:
		print ("Crtl+C Pressed. Shutting down.")